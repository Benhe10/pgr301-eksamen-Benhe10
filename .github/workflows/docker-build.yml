name: Docker build & smoke-test

on:
  pull_request:
    paths:
      - 'sentiment-docker/**'
  push:
    branches:
      - main
    paths:
      - 'sentiment-docker/**'

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      CR_PAT: ${{ secrets.CR_PAT }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Build jar with Maven
        working-directory: sentiment-docker
        run: mvn -B -DskipTests package

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build Docker image
        working-directory: sentiment-docker
        run: |
          # Build image and tag for CI and local-consistency
          docker build -t aialpha-sentiment:ci -t aialpha-sentiment:local .

      - name: Run smoke-test (requires docker)
        working-directory: sentiment-docker
        run: |
          # Allow run_smoketest.sh to use IMAGE env; default is aialpha-sentiment:local
          IMAGE=aialpha-sentiment:local ./run_smoketest.sh

      - name: Push to GHCR if token provided
        if: ${{ env.CR_PAT != '' }}
        run: |
          echo "${{ env.CR_PAT }}" | docker login ghcr.io -u ${{ github.repository_owner }} --password-stdin
          docker tag aialpha-sentiment:ci ghcr.io/${{ github.repository_owner }}/aialpha-sentiment:latest
          docker push ghcr.io/${{ github.repository_owner }}/aialpha-sentiment:latest
